# 简单的开发文档和各模块设计思路

well, 我的代码大家有目共睹，有、烂，所以这个大家看看乐呵乐呵就好

## 设计思路

### ASR和LLM的路由

（我姑且在下文把各种拓展的llm和asr称为“插件”）

1. 让用户在配置文件中填写各个的优先级，和启用状态
2. 调度器在初始化时，根据优先级和启用状态，生成一个路由字典，字典中的每个插件形如：`{"asr_alias": {
   "priority": priority,
   "enabled": enabled,
   "prepared": False,
   "err_times": 0,
   "obj": asr_object
   }, ...}`
3. 当其他模块需要使用时，调用路由器的`get_one()`方法，返回一个插件实例（如果该插件没被初始化，即`prepared=False`
   ，就先进行初始化再传回实例）
4. 当某个插件出错时，调用路由器的`report_error()`方法，将该插件的`err_times`加一，如果`err_times`
   超过了阈值（现在为10），就将该插件的`enabled`置为False
5. 当所有插件都不可用时，调用路由器的`get_one()`方法，会返回None，此时其他模块会通过设置event直接关闭整个程序

### 采用依赖注入

在之前的代码中，出现了很多各种实例来回传递的情况，虽然都是在`main.py`中进行的，不至于太难维护。但确实有够难看...

后来在看其他项目时，了解到python竟然也有inject这种依赖注入包，于是就在代码重构时将项目全部变成依赖注入。具体的代码可以去`core/app.py`
中看，这里就不赘述了。

### 处理链和视频状态记录的实现

处理链说实话不太好抽象，不同操作实现的差异性太多了。但是也是有共性的，比如既然面对的对象是b站视频，所以一定会对字幕、视频基本信息进行操作，所以封装了一下这些操作，让处理链的实现者只需要关注自己的操作就好了。

现在的视频状态记录还是有很大的问题，因为原来的视频记录就是为了完全适配“视频总结”这个功能设计的，没考虑到后期可能会支持其他操作，所以很多的字段都无法共用，后期等待重构吧......

一直说要实现一些新的处理链，太忙了一直没弄，有空了试一下，看看我这个设计是不是一坨答辩

## 开发文档

### ASR及LLM插件开发文档

应该实现什么我在`llm_base.py`和`asr_base.py`中都写了，自己去看吧

路由器在处理时默认将你这个插件的类名转为下划线命名后作为alias（eg.
你类名为LocalWhisper，那生成的alias就为local_whisper），也会依据这个alias去config中寻找配置文件，所以你的配置文件和类名一定要一致。

别忘了在`utils/models.py`中实现你插件的配置模型，并模仿其他插件在主Config中引用

### 处理链开发文档

好吧，我实话实说，我还没试过抽象后的处理链到底好不好添加功能。

不过我能确定的一点是现在处理链还没实现热插拔，如果你要实现新功能，需要修改`bilibili/listen.py`和`main.py`，仿照着摘要处理链进行修改。

`base_chain.py`这个基类起码注释是挺完善了，希望你顺利~